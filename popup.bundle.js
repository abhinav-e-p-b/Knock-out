const video=document.getElementById("webcam"),startBtn=document.getElementById("startBtn"),stopBtn=document.getElementById("stopBtn"),status=document.getElementById("status"),sensitivitySlider=document.getElementById("sensitivity"),scrollSpeedSlider=document.getElementById("scrollSpeed"),sensitivityValue=document.getElementById("sensitivityValue"),scrollSpeedValue=document.getElementById("scrollSpeedValue");let isTracking=!1,stream=null,animationId=null,canvas=null,ctx=null,calibrationData=[],baselineY=null,scrollLock=!1,frameCount=0,smoothedY=null,MOVEMENT_THRESHOLD=25,SCROLL_SPEED=80;const CALIBRATION_FRAMES=90,SMOOTHING_FACTOR=.7,DETECTION_SCALE=.3,hasRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype;let faceDetector=null;if("FaceDetector"in window)try{faceDetector=new FaceDetector({fastMode:!0,maxDetectedFaces:1})}catch(e){console.warn("FaceDetector initialization failed:",e),faceDetector=null}let detectorWorker=null;const pendingWorkerPromises={};if(window.Worker)try{detectorWorker=new Worker("detectorWorker.js"),detectorWorker.onmessage=e=>{const{id:t,faceY:n}=e.data;pendingWorkerPromises[t]&&(pendingWorkerPromises[t](n),delete pendingWorkerPromises[t])}}catch(e){console.warn("Detector worker failed to start:",e),detectorWorker=null}function detectFaceInWorker(e,t,n){return new Promise(o=>{if(!detectorWorker){o(null);return}const a=Math.random().toString(36).slice(2);pendingWorkerPromises[a]=o,detectorWorker.postMessage({id:a,width:t,height:n,buffer:e.data.buffer},[e.data.buffer])})}document.addEventListener("DOMContentLoaded",initializeApp);function initializeApp(){try{canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),updateStatus("Ready! Click Start to begin head tracking.","ready"),startBtn.disabled=!1,setupSettings()}catch(e){console.error("Initialization error:",e),updateStatus("Error: Failed to initialize. Please refresh the page.","error")}}function setupSettings(){sensitivitySlider.addEventListener("input",e=>{MOVEMENT_THRESHOLD=parseInt(e.target.value),sensitivityValue.textContent=MOVEMENT_THRESHOLD}),scrollSpeedSlider.addEventListener("input",e=>{SCROLL_SPEED=parseInt(e.target.value),scrollSpeedValue.textContent=SCROLL_SPEED})}function updateStatus(e,t){status.textContent=e,status.className=`status-${t}`}async function startTracking(){try{updateStatus("Requesting camera access...","loading"),stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640,min:320},height:{ideal:480,min:240},facingMode:"user",frameRate:{ideal:30,min:15}}}),video.srcObject=stream,video.style.display="block",await new Promise((e,t)=>{video.onloadedmetadata=()=>{video.play().then(e).catch(t)},video.onerror=t,setTimeout(()=>t(new Error("Video timeout")),5e3)}),canvas.width=Math.floor(video.videoWidth*DETECTION_SCALE),canvas.height=Math.floor(video.videoHeight*DETECTION_SCALE),isTracking=!0,frameCount=0,calibrationData=[],baselineY=null,smoothedY=null,scrollLock=!1,startBtn.style.display="none",stopBtn.style.display="inline-block",stopBtn.disabled=!1,updateStatus("Calibrating... Please look straight ahead and stay still.","loading"),startDetectionLoop()}catch(e){console.error("Camera error:",e);const t=e.name==="NotAllowedError"?"Camera access denied. Please allow camera access and try again.":"Failed to access camera. Please check your camera and try again.";updateStatus(t,"error"),stopTracking()}}function stopTracking(){isTracking=!1,stream&&(stream.getTracks().forEach(e=>e.stop()),stream=null),animationId&&(cancelAnimationFrame(animationId),animationId=null),video.style.display="none",startBtn.style.display="inline-block",stopBtn.style.display="none",startBtn.disabled=!1,updateStatus("Stopped. Click Start to begin tracking again.","ready")}function startDetectionLoop(){hasRequestVideoFrameCallback?video.requestVideoFrameCallback(handleVideoFrame):detectMovement()}async function handleVideoFrame(){await detectMovement(),isTracking&&video.requestVideoFrameCallback(handleVideoFrame)}async function detectMovement(){if(isTracking){try{let e=null;if(faceDetector)try{const t=await faceDetector.detect(video);if(t.length>0){const n=t[0].boundingBox;e=(n.y+n.height/2)*(canvas.height/video.videoHeight)}}catch(t){console.warn("FaceDetector detect() failed \u2013 falling back to manual detection.",t),e=null}if(e===null){ctx.drawImage(video,0,0,canvas.width,canvas.height);const t=ctx.getImageData(0,0,canvas.width,canvas.height);e=await detectFaceInWorker(t,canvas.width,canvas.height),e===null&&!detectorWorker&&(e=detectFacePosition(t.data,canvas.width,canvas.height))}if(e!==null){if(smoothedY===null?smoothedY=e:smoothedY=smoothedY*SMOOTHING_FACTOR+e*(1-SMOOTHING_FACTOR),frameCount++,frameCount<=CALIBRATION_FRAMES){calibrationData.push(smoothedY);const t=Math.round(frameCount/CALIBRATION_FRAMES*100);updateStatus(`Calibrating... ${t}% complete`,"loading"),frameCount===CALIBRATION_FRAMES&&(baselineY=calibrationData.reduce((o,a)=>o+a,0)/calibrationData.length,updateStatus("Tracking active! Move your head up/down to scroll.","tracking"),console.log("Calibration complete. Baseline Y:",baselineY))}else if(baselineY!==null&&!scrollLock){const t=smoothedY-baselineY;if(Math.abs(t)>MOVEMENT_THRESHOLD){scrollLock=!0;const n=Math.min(Math.abs(t)/MOVEMENT_THRESHOLD,4),o=Math.round(n*SCROLL_SPEED),a=t>0?o:-o;executeScroll(a);const y=t>0?"DOWN":"UP";updateStatus(`Scrolling ${y} (${Math.round(Math.abs(t))}px)`,"tracking"),setTimeout(()=>{isTracking&&frameCount>CALIBRATION_FRAMES&&updateStatus("Tracking active! Move your head up/down to scroll.","tracking")},800),setTimeout(()=>{scrollLock=!1},500)}}}else frameCount>CALIBRATION_FRAMES&&updateStatus("No face detected. Please position yourself in camera view.","error")}catch(e){console.error("Detection error:",e),updateStatus("Detection error. Please try again.","error")}isTracking&&!hasRequestVideoFrameCallback&&(animationId=requestAnimationFrame(detectMovement))}}function detectFacePosition(e,t,n){const E=t/2,M=n*.4;let g=null,p=-1/0;for(let l=Math.floor(n*.15);l<n*.85;l+=15)for(let s=Math.floor(t*.25);s<t*.75;s+=15){let b=0,k=0,f=0;for(let d=0;d<30&&l+d<n;d++)for(let u=0;u<30&&s+u<t;u++){const h=((l+d)*t+(s+u))*4,i=e[h],r=e[h+1],c=e[h+2];b+=i*.299+r*.587+c*.114,f++,i>95&&r>40&&c>20&&Math.max(i,r,c)-Math.min(i,r,c)>15&&Math.abs(i-r)>15&&i>r&&i>c&&k++}const m=b/f,w=k/f;if(m<=60||m>=220||w<=.1)continue;const C=s+15,v=l+15,T=Math.hypot(C-E,v-M),S=m*.7+w*1e3-T*.1;S>p&&(p=S,g={y:v})}return g?g.y:null}async function executeScroll(e){try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t)throw new Error("No active tab found");await chrome.scripting.executeScript({target:{tabId:t.id},func:n=>{window.scrollBy({top:n,behavior:"smooth"})},args:[e]})}catch(t){console.error("Scroll error:",t),updateStatus("Cannot scroll this page. Try a different tab.","error"),setTimeout(()=>{isTracking&&frameCount>CALIBRATION_FRAMES&&updateStatus("Tracking active! Move your head up/down to scroll.","tracking")},2e3)}}startBtn.addEventListener("click",startTracking),stopBtn.addEventListener("click",stopTracking),window.addEventListener("beforeunload",()=>{isTracking&&stopTracking()}),document.addEventListener("visibilitychange",()=>{document.hidden&&isTracking&&console.log("Popup hidden, pausing tracking")});
